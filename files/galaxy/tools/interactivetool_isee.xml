<tool id="interactive_tool_isee" tool_type="interactive" name="iSEE" version="0.0.1">
  <requirements>
    <container type="docker">neoformit/galaxy-isee-it</container>
  </requirements>

  <entry_points>
    <entry_point name="iSEE Single Cell Visualisation" requires_domain="True">
      <!-- This port is exposed by the docker container -->
      <port>8888</port>
    </entry_point>
  </entry_points>

  <command><![CDATA[

      ## WDIR: /import

      #set INPUT_PATH = "sce"
      #set RSCRIPT = '/scripts/isee.R'

      ln -s '$input.extra_files_path' '$INPUT_PATH' &&
      ln -s '$isee_script' '$RSCRIPT' &&
      ln -s '${__tool_directory__}/isee/params_config.py' ./params_config.py &&
      cp '$isee_script' '$outfile' &&

      /scripts/run.sh '$RSCRIPT' >> /var/log/isee.log 2>&1

  ]]>
  </command>

  <configfiles>
    <configfile name="isee_script"><![CDATA[
      shhh <- suppressPackageStartupMessages # It's a library, so shhh!

      shhh(library(iSEE))
      shhh(library(HDF5Array))


      #set INPUT_PATH = "sce"
      sce_path <- '$INPUT_PATH'
      sce <- loadHDF5SummarizedExperiment(sce_path)
      app <- iSEE(sce,
      #if $custom.selected
          #if $custom.method == 'custom'
              ## Template with custom config file (R code)
              # CUSTOM PARAMS NOT YET CONFIGURED
          #else if $custom.method == 'choice'
              ## Template with choices in params_config.py
              # CHOICE PARAMS NOT YET CONFIGURED
          #end if
      #end if
      )
      suppressWarnings(
          shiny::runApp(app, host="0.0.0.0", port=8888, quiet=TRUE))
    ]]>
    </configfile>
  </configfiles>

  <inputs>
    <param
      name="input"
      type="data"
      format="rdata.se"
      label="HDF5SummarizedExperiment: rdata.se (composite)"
      help="This datatype represents a HDF5SummarizedExperiment object as
        exported from R."
    />

    <!-- NOT YET CONFIGURED -->
    <conditional name="custom">
      <param name="selected" label="Customize iSEE parameters" type="boolean"  hidden="true"/>

      <when value="true">

        <conditional name="method">
          <param name="selected" label="Method" type="select">
            <option value="choice" selected="true"> Preconfigured options </option>
            <option value="custom"> Custom R configuration </option>
          </param>

          <when value="choice">
            <!-- Choices to go here as repeat (plots) and select (colors) -->
            <!-- Not sure about "extras" -->

          </when>

          <when value="custom">
            <param
              name="isee_params"
              type="data"
              format="txt"
              label="iSEE parameters"
              help="Pass arbitrary keyword arguments to iSEE().
                In order to use this field, please upload a text dataset containing
                valid R code (you may wish to use the paste function to upload)."
              />
          </when>
        </conditional>

      </when>
    </conditional>
  </inputs>

  <outputs>
    <data name="outfile" format="txt"
          label="${tool.name} on ${on_string}: Rscript" />
  </outputs>

  <tests>
    <test expect_num_outputs="1">
    </test>
  </tests>

  <help><![CDATA[

**Overview**

iSEE provides a web interface for visualising single-cell transcriptomics
datasets encapsulated in an HDF5SummarizedExperiment object.

-----

**Input**

The tool takes a single HDF5SummarizedExperiment dataset as an input,
which can be uploaded as a composite datatype ``rdata.se``, and requires
two input files: ``se.rds`` and ``assays.h5``. These data can be rendered
from the R ``HDF5SummarizedExperiment`` object with the function
``saveHDF5SummarizedExperiment()``. This object comes with the R package
``HDF5Array``.

-----

**Useful links:**

Documentation on ``HDF5SummarizedExperiment``:

https://rdrr.io/bioc/HDF5Array/man/saveHDF5SummarizedExperiment.html

HDF5Array manual:

https://bioc.ism.ac.jp/packages/3.7/bioc/manuals/HDF5Array/man/HDF5Array.pdf

    ]]>
  </help>

  <citations>
    <citation type="bibtex">
      @article{rue2018isee,
        title={iSEE: interactive summarizedexperiment explorer},
        author={Rue-Albrecht, Kevin and Marini, Federico and Soneson,
          Charlotte and Lun, Aaron TL},
        journal={F1000Research},
        volume={7},
        year={2018},
        publisher={Faculty of 1000 Ltd}
      }
    </citation>
  </citations>
</tool>
